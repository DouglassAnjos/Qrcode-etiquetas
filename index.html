<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador 3D - Intprocess</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        canvas { display: block; }
        #controls { padding: 10px; background-color: #f0f0f0; display: flex; gap: 10px; }
        #log { height: 100px; background: #eaeaea; overflow-y: auto; padding: 10px; }
        #version { text-align: center; padding: 5px; background-color: #d3d3d3; }
    </style>
</head>
<body>
    <div id="controls">
        <input type="file" id="fileInput" accept="application/json">
        <button onclick="resetCamera()">Redefinir Câmera</button>
    </div>
    <div id="log">Log de erros aparecerá aqui...</div>
    <div id="version">Versão 1.0.4</div>
    <script>
        let scene, camera, renderer, controls;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight - 150);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.enableRotate = true; // Permitir rotação
            controls.enableZoom = true;   // Permitir zoom
            controls.enablePan = true;    // Permitir mover lateralmente
            controls.minDistance = 100;
            controls.maxDistance = 3000;
            controls.target.set(400, 250, 0);  // Centraliza a peça na tela

            const light = new THREE.AmbientLight(0x404040); // luz suave ambiente
            scene.add(light);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5).normalize();
            scene.add(directionalLight);

            camera.position.set(400, 250, 1500);  // Afastar mais a câmera
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function loadModel(json) {
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(json.vertices, 3));

            const material = new THREE.MeshBasicMaterial({
                map: loadTexture(json.texture) || new THREE.Color(0xff0000), 
                side: THREE.DoubleSide  // Garante que ambos os lados do plano sejam visíveis
            });

            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }

        function loadTexture(textureName) {
            if (!textureName) return null;
            const loader = new THREE.TextureLoader();
            return loader.load(`./${textureName}`,
                undefined,
                undefined,
                () => logError(`Erro ao carregar a textura: ${textureName}`)
            );
        }

        function logError(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<p>${message}</p>`;
        }

        document.getElementById('fileInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    loadModel(json);
                } catch (error) {
                    logError('Erro ao carregar o arquivo JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function resetCamera() {
            camera.position.set(400, 250, 1500);
            controls.target.set(400, 250, 0);
        }

        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight - 150);
            camera.aspect = window.innerWidth / (window.innerHeight - 150);
            camera.updateProjectionMatrix();
        });

        document.addEventListener("DOMContentLoaded", function () {
            init();
        });
    </script>
</body>
</html>
